# システムアーキテクチャ

> システムアーキテクチャ構成を定義する.

## サービス分割

> 今回はBusiness Capabilitiesパターンで機能ごとの分割を行う.

### メンバー管理サービス (Member Management Service)
- **責務**: メンバーの登録, 更新, 削除を管理.
- **技術スタック**: Node.js/Java/Spring Boot, PostgreSQL/MySQL for storage.
- **主な機能**:
  - メンバーの詳細情報の保持.
  - メンバーリストの提供, 検索機能.

### ロール管理サービス (Role Management Service)
- **責務**: ロールとポリシーの定義と管理.
- **技術スタック**: Java/Spring Boot, PostgreSQL/MySQL.
- **主な機能**:
  - ロールの作成, 更新, 削除.
  - ロールに対するポリシーのアタッチメントと管理.
  - ロールとユーザーの関連付け.

### 認証認可サービス (Authentication and Authorization Service)
- **責務**: ユーザーの認証と認可を管理.
- **技術スタック**: Spring Security, Spring Boot, Keycloak, MongoDB.
  - API Gatewayとのインテラクションにおいては同期実行が必要なため高速であるgRPCを利用.
- **主な機能**:
  - ログイン認証とJWTトークンの発行.
  - ユーザーのアクセス権限の確認と権限に基づくリソースアクセスの制御.
  - OAuth2.0プロトコルの実装.
  - 独自のデータストアを持ち, 以下の機能を実装する.
    - メンバー管理サービスとロール管理サービスの変更により, このデータストアも同期させる.
      - ログイン時の読み取り専用という形になるため, CQRSのクエリ専用に近いが, 両方のパターンで利用する.
      - また, 権限に関する整合性はどの場面でも重要であるため, Event SourcingではなくSagaによる変更とする.
      - 保持する内容は, `loginID`, `password`, `memberID`, `[]policyID`(もしくは`roleID`)となる.

### グループサービス (Group Management Service)
- **責務**: グループの作成, 更新, 管理.
- **技術スタック**: Node.js/Java, MongoDB/PostgreSQL.
- **主な機能**:
  - グループとサブグループの階層構造の管理.
  - グループ内のタグ管理.
  - 全体グループ管理.
  - グループへのメンバーの所属, 脱退, 追放機能.

### ワークポジションサービス (Work Position Management Service)
- **責務**: グループ内でのワークポジションの管理.
- **技術スタック**: Python/Django, PostgreSQL.
- **主な機能**:
  - グループ固有のポジションの作成と管理.
  - ワークポジションに基づくパーミッションの割り当て.
  - グループ内でのメンバーへのワークポジション紐付け.

### チャネルサービス (Channel Management Service)
- **責務**: コミュニケーションチャネルの設定と管理.
- **技術スタック**: Go, Redis.
- **主な機能**:
  - チャネルの作成, 更新, 削除.
  - Defaultチャネルの作成, 管理.
  - 投稿に関するスレッド管理.
  - 他サービスとの連携投稿や紐付け.

### ストレージサービス (Storage Management Service)
- **責務**: ファイルのアップロード, ダウンロード, ID管理.
- **技術スタック**: Python/Flask, Amazon S3, Elasticsearch.
- **主な機能**:
  - ファイルとディレクトリの管理.
  - ストレージの自動作成とバケットのCRUD.
  - Defaultバケットの管理.

### チャットサービス (Chat Management Service)
- **責務**: リアルタイムチャットと通信の実施.
- **技術スタック**: Node.js, WebSocket, Redis.
- **主な機能**:
  - チャットルームの作成と管理.
  - 個人チャットの管理.
  - チャット内のメンバー管理.
  - グループに紐付いたチャットルームの制御.
  - メッセージのリアルタイム送受信.

### WebSocketサービス (WebSocket Service)
- **責務**: リアルタイムでのイベント通知とデータ配信.
- **技術スタック**: Go, Redis.
  - Redisにてソケット情報とユーザーID, JobIDの紐付けを集権管理.
  - KafkaでJob管理サービスからのメッセージングをサブスクライブしている.
- **主な機能**:
  - クライアントとのWebSocket接続の維持.
  - イベント駆動型の通知の送信.
  - 他のサービス（特にJob管理サービス）からのイベントの購読.

### Job管理サービス (Job Management Service)
- **責務**: 非同期タスクの管理と状態追跡.
- **技術スタック**: Go, Kafka, Redis.
  - 有効期限付きでJobを保存する, リアルタイム性が求められるためRedisを利用.
  - Jobの状態確認のリクエストはgRPCで返却.
  - JobID発行以降のjob状態更新リクエストはメッセージングのpoint-to-pointで対応.
  - jobの完了や失敗に関して, KafkaにてPublishを行う
- **主な機能**:
  - ジョブIDの発行とジョブの進行状況の追跡.
  - 各サービス間のタスク完了や失敗の通知.
  - APIゲートウェイとの連携を通じてジョブの管理と更新を行う.
  - 各ドメインサービスからJobに関する更新, 完了, 失敗を保持.

### API Gateway
- **責務**: クライアントからの単一エンドポイント.
- **技術スタック**: Go/Spring.
  - マネージドサービスやOSS, Ingressなどではカスタマイズが難しく, 特にAPI CompositionやKafkaへのメッセージングなど通常のルーティングのみで完結することではないためスクラッチ実装.
  - フロントからの呼び出しはRESTで受付.
  - JobIDの発行のためのJob管理サービス呼び出しやauthサービスの呼び出し, クエリ系呼び出しはgRPCを利用.
  - コマンド系呼び出しはメッセージングを利用.
- **主な機能**:
  - API Compositionパターンの場合, データの収集と結合.
  - クエリであればgRPC, コマンドであればKafkaへのルーティング.
  - コマンドはJob管理サービスからJobIDを受け取り次第, メッセージングを行う.
  - トレーシングのためのID発行とコンテキストへの付与.
  - メッセージングを送信できるためのリクエスト簡易バリデーション.

## CQRSにおけるクエリ専用サービス

## 基本的な設計

- EFKスタックによるログ収集.
- Prometheus, Grafanaによるメトリクス収集.
- OpenTelemetry, Jeagerによる分散トレーシング.
- Kubernetes on AWS(EKS).
- メッセージングにはApache Kafka.
- トランザクショナルメッセージングのためdebezium, dynamoDB Stream, Change Streamsなど利用したアウトボックスパターン.
- Sagaのオーケストラは最初に呼び出された(最も重要な変更のある)ドメインサービス.
- メッセージングやprotoスキーマのための最低限バリデーションはAPI Gatewayで行うものの, ロジック上でのバリデーションは各ドメインサービスに委ねる.
- 本来ならcqrsは読み取りが頻繁な箇所や, データの整合性を重視しない部分での導入がよくあるが今回は研究対象のすべてのクエリはクエリ用サービスを利用する.